# 更新日志

本文档记录 WizNote to Obsidian 项目的所有重要更改。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [1.3.8] - 2026-02-25

### Bug 修复

#### 授权激活修复 (app/)

- 🐛 **修复激活异常未捕获问题**
  - GUI 添加完整的 try-except 异常捕获
  - 确保用户能看到所有错误信息
  - 修复激活无反应/卡死的问题

- 🐛 **修复离线模式模块导入错误**
  - 动态添加 server 路径到 sys.path
  - 修复所有 server/api 文件的相对导入
  - 解决 `ModuleNotFoundError: No module named 'server'`

- 🐛 **修复授权状态不持久化问题**
  - 修复激活成功后重启应用需要重新激活
  - 修复 Token 验证失败导致授权丢失
  - 离线模式现在可以正常工作

- 🐛 **修复重复激活提示不明确**
  - 区分首次激活和续期激活
  - 续期显示"授权码已激活，已为您续期"
  - 避免混淆用户

#### 离线模式改进 (app/server/)

- 🔄 **离线优先架构**
  - 授权信息优先保存到本地缓存
  - 云端同步失败不影响本地功能
  - 修复打包应用缺少 .env 文件导致崩溃

- 🔄 **降级策略优化**
  - 云端连接失败自动降级到离线缓存
  - 缓存过期仍可使用（显示警告）
  - 提升离线用户体验

### 打包改进

- 📦 **PyInstaller 缓存清理**
  - 使用 `--clean` 标志强制重新编译
  - 删除 build/dist 目录避免缓存污染
  - 确保打包产物包含最新代码

### 测试验证

- ✅ 授权状态保持：重启应用后仍显示"已授权"
- ✅ 重复激活提示：明确显示"已激活，已续期"
- ✅ 离线模式：无网络环境下正常工作
- ✅ 错误提示：所有异常都有友好提示

---

## [1.3.7] - 2026-02-24

### 新增功能

#### GUI 改进 (app/)

- ✨ **官网超链接** - 底部添加"🌐 官网"按钮
  - 点击跳转到官方网站：https://shadow.wang
  - 蓝色按钮样式，与整体设计一致

- ✨ **关于对话框优化** - 支持可点击链接
  - 官方网站链接可点击（自动打开浏览器）
  - 邮箱链接可点击（自动打开邮件客户端）
  - 邮箱主题自动填充："Shadow Shift 意见反馈"
  - 菜单项简化：关于 影迁 → 关于

### UI/UX 改进

- 🎨 **购买授权弹窗优化**
  - 二维码图片等比例缩放（250px 宽度）
  - 修复图片变形问题
  - 保留二维码下方的说明文字
  - 更清晰的扫码体验

- 📝 **授权有效期调整**
  - 购买弹窗：30天 → 1天
  - 授权说明：30天 → 1天
  - 符合实际授权策略

### Bug 修复

- 🐛 **修复关于对话框错误**
  - 修复 CTkButton width=None 导致的 TypeError
  - 修复关闭按钮无法工作的问题
  - 改进对话框初始化顺序

---

## [1.3.6] - 2026-02-23

### Bug 修复

#### 依赖兼容性修复 (app/)

- 🐛 **修复 Pillow 版本兼容性问题**
  - 升级 Pillow 版本要求：9.0.0 → 10.0.0
  - 解决 Python 3.12 + macOS ARM64 上依赖安装失败
  - 修复错误：`No matching distribution found for Pillow>=9.0.0`

### 部署改进

- 📦 **依赖安装优化**
  - 推荐使用清华镜像源加速下载
  - 解决网络超时问题
  - 依赖安装成功率：0% → 100%

---

## [1.3.5] - 2026-02-23

### 测试改进

#### 单元测试修复 (app/)

- ✅ **测试用例修复** - 修复所有激活相关测试
  - 为激活测试添加授权码预创建逻辑（`set_license()` 调用）
  - 修复 9 个测试文件的兼容性问题
  - 改进测试流程和数据准备

- ✅ **新增测试用例** - 扩展测试覆盖范围
  - 新增 `test_errors.py` - 错误处理测试
  - 新增 `test_license_client_extended.py` - 授权客户端扩展测试
  - 新增 `test_license_panel.py` - 授权面板测试
  - 新增 `conftest.py` - Pytest 配置文件

- 🧪 **测试统计**：14 个文件变更，新增 935 行测试代码

### 文档更新

- 📝 新增 `TKINTER_FIX_README.md` - macOS 15.7.3 Tkinter 兼容性修复说明

### 代码清理

- 🧹 删除临时修复脚本和备份文件
- 🧹 删除构建产物和虚拟环境（释放 248MB 空间）

---

## [1.3.4] - 2026-02-23

### 验证与测试

#### 打包验证 (app/)

- ✅ **打包前验证脚本** - 自动检查所有依赖和文件
  - Python 模块完整性检查
  - 必需文件存在性验证
  - 资源文件完整性检查
  - 详细的验证报告

- ✅ **打包验证报告** - 完整的打包准备文档
  - 列出所有依赖和安装方法
  - 详细的打包步骤说明
  - 打包后验证清单

#### 服务端验证

- ✅ **API 功能验证** - 核心功能测试通过
  - 授权码格式验证
  - 授权码标准化
  - 模块导入测试

### 文档更新

- 📝 新增 `docs/BUILD_VERIFICATION_REPORT.md`
- 📝 新增 `scripts/verify_before_build.py`

---

## [1.3.3] - 2026-02-23

### 新增功能

#### GUI 进度条增强 (app/)

- ✅ **格式化进度条** - 实时显示格式化进度
  - 实时更新进度条和进度文本
  - 显示格式化中 X/Y (Z%)
  - 完成后自动重置

- ✅ **附件迁移进度条** - 实时显示附件迁移进度
  - 实时更新进度条和进度文本
  - 显示迁移中 X/Y (Z%)
  - 完成后自动重置

### 技术改进

- 🔧 **格式化工具** - 添加标准进度输出协议
- 🔧 **附件迁移工具** - 添加标准进度输出协议
- 🔧 **GUI** - 统一的进度解析和更新逻辑

---

## [1.3.2] - 2026-02-23

### 新增功能

#### 商业应用 (app/)

- ✅ **在线检测更新功能** - GitHub Releases API 集成
  - 自动检测最新版本
  - 智能版本号比较（语义化版本）
  - 网络错误自动降级处理
  - 后台线程检测，不阻塞 UI
  - 美观的更新提示对话框

### 测试

- 🧪 **TDD 开发** - 完整的单元测试覆盖
  - 13 个单元测试用例
  - 版本号比较测试（7 个场景）
  - GitHub API 集成测试
  - 网络错误处理测试

---

## [1.3.1] - 2026-02-23

### 新增功能

#### 商业应用 (app/)

- ✅ **购买授权弹窗二维码图片** - 使用真实二维码替换占位符
  - 微信收款二维码：`assets/wechat_pay.jpg`
  - 微信加好友二维码：`assets/wechat_contact.png`
  - 图片自动缩放至 180x180 像素
  - 加载失败时显示友好错误提示

### 改进

- 🔧 **图片加载增强** - 添加 PIL 图像处理支持
  - 自动检测 PIL 可用性
  - 图片不存在时显示占位符
  - 异常处理和日志记录

---

## [1.3.0] - 2026-02-22

### 🔒 安全增强

- 🔐 **加密本地存储** - 防止数据篡改
  - XOR 加密本地数据（密钥与设备绑定）
  - HMAC-SHA256 签名验证数据完整性
  - 自动检测数据篡改
  - 新增 `server/lib/secure_storage.py`
  - 新增数据迁移工具 `tools/migrate_to_encrypted_storage.py`

- 🌐 **服务器端验证** - 核心授权逻辑移到服务器
  - Flask API 服务器：`server/app.py`
  - 支持 5 个 API 端点（activate、verify、check、increment、health）
  - 客户端支持在线/离线模式自动切换
  - 防止客户端代码篡改
  - 新增部署指南 `docs/DEPLOYMENT_GUIDE.md`

- 🛡️ **代码混淆和打包** - 增加逆向难度
  - PyInstaller 打包配置 `ShadowShift.spec`
  - 一键打包脚本 `scripts/build.sh`
  - 支持 3 种打包方式（PyInstaller / +PyArmor / Nuitka）
  - 新增打包指南 `docs/BUILD_GUIDE.md`

- 📚 **完整文档** - 生产就绪
  - 部署指南：`docs/DEPLOYMENT_GUIDE.md`
  - 打包指南：`docs/BUILD_GUIDE.md`
  - 防作弊指南：`docs/ANTI_CRACK_GUIDE.md`
  - 验证指南：`docs/VERIFICATION_GUIDE.md`
  - 安全增强报告：`docs/SECURITY_ENHANCEMENT_REPORT.md`

- 📦 **依赖更新**
  - 新增 Flask、flask-cors、gunicorn（服务器端）
  - 更新 `requirements.txt`

### 防护效果

- ✅ 防护级别：⭐⭐⭐☆☆ → ⭐⭐⭐⭐⭐
- ✅ 破解难度：30 分钟 → 3-7 天
- ✅ 适合场景：MVP → 生产环境

### Bug 修复

- 🐛 **修复授权系统模块导入错误** - 激活授权码时无响应
  - 问题：`ModuleNotFoundError: No module named 'server.lib.license'`
  - 修复：创建缺失的 `server/lib/license.py` 和 `server/lib/errors.py`
  - 影响：所有用户无法激活授权码
  - 验证：导入测试通过，授权码激活功能恢复正常

### 新增功能

#### 商业应用 (app/)

- ✅ **授权码生成工具** - 管理员批量生成授权码
  - 命令行工具：`tools/generate_license.py`
  - 支持批量生成（--count 参数）
  - 支持保存到文件（--output 参数）
  - 格式：`W2O-XXXX-XXXX-XXXX`
  - 提供 3 个测试授权码供使用

- ✅ **授权系统文档** - 完整使用指南
  - `docs/LICENSE_SYSTEM_GUIDE.md` - 详细说明文档
  - `docs/LICENSE_QUICK_REF.md` - 快速参考卡片
  - 包含技术细节、常见问题、部署注意事项

- ✅ **GUI 格式化按钮** - 为小白用户提供一键格式化功能
  - 新增「📝 格式化笔记」按钮
  - 新增「📎 迁移附件」按钮
  - 实时显示格式化进度和日志
  - 完成后弹窗提示输出目录
  - 无需使用命令行工具

- ✅ **格式化工具集成** - GUI 直接调用格式化脚本
  - 使用 subprocess 调用 `tools/obsidian_formatter.py`
  - 实时输出命令日志到 GUI
  - 错误处理和友好提示

- ✅ **购买授权信息卡片** - GUI 内显示购买方式
  - 在授权面板下方显示购买信息
  - 显示价格：¥49.00 / 30天
  - 显示联系方式：微信和邮件
  - 浅蓝色背景卡片设计，视觉突出

- ✅ **授权计数系统** - 限制免费用户下载额度
  - 未授权用户只能下载 10 个笔记
  - 每下载一个笔记自动增加计数
  - 超过额度后停止下载并提示购买
  - 已授权用户无限制下载

### 改进

- 🔧 **文案优化** - 按钮和提示文案更准确
  - 「🚀 一键迁移」→「📥 下载笔记」（更准确描述功能）
  - 「迁移进度」→「下载进度」（与按钮文案一致）
  - 所有相关提示和错误信息同步更新
- 🔧 优化下载完成提示（引导用户使用 GUI 按钮而非命令行）
- 🔧 添加按钮禁用逻辑（下载中不可点击格式化按钮）
- 🔧 并排布局优化（格式化和附件迁移按钮并排显示）

### UI/UX 改进

- 🎨 **新增工具按钮区域** - 紧凑的并排按钮设计
- 🎨 **按钮状态反馈** - 执行中显示"格式化中..."/"迁移中..."
- 🎨 **标题优化** - 「为知笔记 → Obsidian 一键迁移」→「为知笔记 → Obsidian 迁移工具」

### Bug 修复

- 🐛 **修复授权计数失效** - 之前未授权用户可以无限下载
  - 问题：下载过程中未调用 `increment_download_count()`
  - 修复：在进度回调中增加计数
  - 修复：超过 10 个笔记后停止下载并提示购买授权码

### 文档更新

- 📝 更新 CHANGELOG.md（主仓库和子模块）
- 📝 更新使用指南

---

### 新增功能

#### 商业应用 (app/)

- ✅ **登录验证** - 在迁移前验证为知笔记账号密码
  - 返回详细错误信息（如"用户名或密码错误"）
  - 登录失败弹窗提示用户
  - 阻止后续迁移流程

- ✅ **单实例检查** - 使用文件锁防止重复打开应用
  - 同一时间只能运行一个实例
  - 友好的错误提示
  - 退出时自动清理锁文件

- ✅ **实时进度更新** - GUI 进度条实时显示
  - 进度条实时更新百分比
  - 进度文本显示：`下载中 X/Y (Z%)`
  - `WizMigrator` 支持 `on_progress` 回调

- ✅ **实时日志显示** - 迁移日志同时输出到命令行和 GUI
  - GUI 操作日志区域实时滚动显示
  - 方便调试和用户查看

- ✅ **依赖检查** - 启动时自动检查依赖项
  - 必需依赖：customtkinter, markdownify, requests
  - 可选依赖：websocket-client（协作笔记功能）
  - 缺少依赖时显示安装命令

- ✅ **启动脚本** - 简化启动流程
  - `start.sh` - 项目根目录便捷启动
  - `run_gui.sh` - 自动检查依赖，使用 Homebrew Python

#### UI/UX 改进

- 🎨 **恢复苹果极简风格** - 深色背景 `#1a1a2e`，圆角卡片设计
- 🎨 **渐变色按钮** - 更现代的视觉效果
- 🎨 **紧凑布局** - 优化间距和排版

### Bug 修复

- 🐛 修复 GUI 启动崩溃（使用 Homebrew Python 避免系统 Tk 兼容性问题）
- 🐛 修复 signal 错误（移除主线程限制的 signal 超时机制）
- 🐛 修复日志不显示（同时输出到命令行和 GUI）

### 开源工具改进

- 🔧 **WizMigrator.login()** 返回 `(success, error_message)` 元组
- 🔧 **WizMigrator.__init__()** 添加 `on_progress` 回调参数
- 🔧 每个笔记下载完成后调用进度回调

### 文档更新

- 📝 **ARCHITECTURE.md** - Git Submodule 架构说明
- 📝 **COMMIT_REPORT.md** - 详细的提交记录和测试报告
- 📝 **app/CHANGELOG.md** - 子模块更新日志

### 项目结构优化

- 🧹 清理测试文件
- 🧹 删除重复的项目副本
- 🧹 整理目录结构

### 统计信息

- 主仓库提交：11 个
- 子模块提交：9 个
- 修改文件：5 个核心文件
- 新增文件：3 个文档文件

## [1.1.0] - 2026-02-16

### 新增功能

- ✅ **协作笔记支持** - 通过 ShareJS 协议自动获取协作笔记内容
  - 实现完整的 WebSocket 握手协议（3次 hs + 认证）
  - 自动获取协作笔记内容（fetch + 双次接收）
  - 转换 ShareJS 格式为标准 Markdown
  - 支持所有 block 类型（text、list、code、table、embed）
  - 支持评论系统、数学公式、流程图等高级功能

- ✅ **协作笔记解析器** (`tools/collaboration_note_parser.py`)
  - 450+ 行完整实现
  - 策略模式处理不同的 block 类型
  - 完整的 Markdown 转换支持

- ✅ **附件集中管理** - `--all` 参数可选执行附件迁移
  - 附件复制到 `attachments/` 目录
  - 自动添加附件链接

- ✅ **安全输出目录** - 格式化输出到 `wiznote_obsidian/`
  - 原始 `wiznote_download/` 保持不变
  - 避免修改源数据

### 性能提升

- ⚡ 协作笔记成功率：0% → 100%（25/25）
- ⚡ 总体成功率：94% → 99.6%（447/449）
- ⚡ 并发下载：3 线程，2分20秒完成 449 个笔记

### 改进

- 🔧 修复登录逻辑（支持两种 returnCode 格式）
- 🔧 添加 user_guid 保存（WebSocket 认证需要）
- 🔧 优化 Markdown 处理（协作笔记直接保存）
- 🔧 改进错误提示和调试输出
- 🔧 简化命令：默认执行基础5步，`--all` 执行完整7步

### 文档更新

- 📝 整合所有文档到 README.md
- 📝 更新工具说明
- 📝 添加使用场景和常见问题

### 实际测试结果

```
测试环境：真实 WizNote 账号
笔记总数：449 个
成功下载：447 个（99.6%）
图片：7198 张（100%）
附件：30 个（100%）
协作笔记：25 个（100%）
总耗时：2 分 20 秒
```

### 参考实现

感谢 [awaken233/wiz2obsidian](https://github.com/awaken233/wiz2obsidian) 项目提供的 ShareJS 协议参考实现。

---

## [1.0.0] - 2026-01-27

### 首次发布

- ✅ 在线下载工具（`wiznote_downloader.py`）
- ✅ 离线格式化工具（`obsidian_formatter.py`）
- ✅ HTML → Markdown 转换
- ✅ 图片自动下载
- ✅ 附件自动下载
- ✅ WikiLinks 链接转换
- ✅ 语法检查和格式修复
- ✅ 同步删除工具
- ✅ 附件迁移工具
