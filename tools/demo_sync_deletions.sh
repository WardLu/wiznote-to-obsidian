#!/bin/bash
# 同步删除工具演示脚本
# 展示完整的使用流程

echo "╔══════════════════════════════════════════════════════════════╗"
echo "║          同步删除工具 - 完整使用演示                         ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo ""

# 设置演示目录
EXPORT_DIR="$HOME/Documents/VibeCoding/Wiznote to Obisidian/obsidian_export/My Notes/读书笔记"
VAULT_DIR="$HOME/Documents/Vard's Obsidian"

echo "📂 演示场景：同步删除读书笔记"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "源目录: $EXPORT_DIR"
echo "目标目录: $VAULT_DIR"
echo ""

# 检查目录是否存在
if [ ! -d "$EXPORT_DIR" ]; then
    echo "⚠️  源目录不存在，使用模拟演示"
    DEMO_MODE=1
else
    DEMO_MODE=0
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "第 1 步：扫描差异（只查看，不删除）"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# 执行扫描
echo "🔍 运行命令："
echo "python3 sync_deletions.py \\"
echo "  --source '$EXPORT_DIR' \\"
echo "  --target '$VAULT_DIR' \\"
echo "  --scan"
echo ""

if [ $DEMO_MODE -eq 0 ]; then
    python3 tools/sync_deletions.py \
        --source "$EXPORT_DIR" \
        --target "$VAULT_DIR" \
        --scan
else
    echo "📋 模拟输出："
    cat << 'EOF'
🔍 扫描模式（只查看，不删除）

🔍 扫描删除差异...
源目录: /Users/xxx/wiznote_export/My Notes/读书笔记
目标目录: /Users/xxx/ObsidianVault

📂 扫描源目录文件...
   找到 15 个文件

📂 扫描目标目录文件...
   找到 20 个文件

🔍 分析文件差异...

================================================================================
📋 同步删除报告
================================================================================

📊 统计信息
   扫描时间: 2026-02-02 20:30:15
   源目录文件数: 15
   目标目录文件数: 20
   需要删除的文件: 5

⚠️  需要删除的文件清单
--------------------------------------------------------------------------------

1. My Notes/读书笔记/启示录：如何打造用户喜爱的产品.md
   源文件: My Notes/读书笔记/启示录：如何打造用户喜爱的产品.md
   映射关系: My Notes/读书笔记/启示录：如何打造用户喜爱的产品.md → My Notes/读书笔记/启示录：如何打造用户喜爱的产品.md
   相似度: 100.0%
   原因: 源文件已删除

2. My Notes/读书笔记/从点子到产品：产品经理的价值观与方法论 读书笔记.md
   源文件: My Notes/读书笔记/从点子到产品：产品经理的价值观与方法论 读书笔记.md
   映射关系: My Notes/读书笔记/从点子到产品：产品经理的价值观与方法论 读书笔记.md → My Notes/读书笔记/从点子到产品：产品经理的价值观与方法论 读书笔记.md
   相似度: 100.0%
   原因: 源文件已删除

3. My Notes/读书笔记/金字塔原理.md
   源文件: My Notes/读书笔记/金字塔原理.md
   映射关系: My Notes/读书笔记/金字塔原理.md → My Notes/读书笔记/金字塔原理.md
   相似度: 100.0%
   原因: 源文件已删除

4. My Notes/读书笔记/小狗钱钱.md
   源文件: My Notes/读书笔记/小狗钱钱.md
   映射关系: My Notes/读书笔记/小狗钱钱.md → My Notes/读书笔记/小狗钱钱.md
   相似度: 100.0%
   原因: 源文件已删除

5. My Notes/读书笔记/硅谷产品实战36讲——曲晓音.md
   源文件: My Notes/读书笔记/硅谷产品实战36讲——曲晓音.md
   映射关系: My Notes/读书笔记/硅谷产品实战36讲——曲晓音.md → My Notes/读书笔记/硅谷产品实战36讲——曲晓音.md
   相似度: 100.0%
   原因: 源文件已删除

================================================================================
⚠️  警告：以上 5 个文件将被删除！
================================================================================

📄 扫描报告已保存到: .sync_delete_scan_report.json

💡 下一步：
   1. 仔细查看上面的删除清单
   2. 确认无误后，运行以下命令执行删除：
      python3 sync_deletions.py --confirm --source 'xxx' --target 'xxx'
EOF
fi

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "第 2 步：仔细检查删除清单"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "✅ 检查要点："
echo "   1. 删除的文件数是否正确？"
echo "   2. 映射关系是否正确？"
echo "   3. 是否有误删风险？"
echo ""

if [ -f ".sync_delete_scan_report.json" ]; then
    echo "📄 扫描报告已生成，可以查看："
    echo "   cat .sync_delete_scan_report.json"
    echo ""
fi

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "第 3 步：确认删除（需要手动输入 yes）"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "⚠️  只有确认无误后才执行此步骤！"
echo ""
echo "🔍 运行命令："
echo "python3 sync_deletions.py \\"
echo "  --source '$EXPORT_DIR' \\"
echo "  --target '$VAULT_DIR' \\"
echo "  --confirm"
echo ""

echo "系统会提示："
echo "⚠️  确认删除操作"
echo "================================================================================"
echo "你已查看删除清单，确认要删除这些文件吗？(yes/no):"
echo ""
echo "✅ 输入 'yes' 才会执行删除"
echo "❌ 输入 'no' 或其他内容会取消操作"
echo ""

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "第 4 步：查看删除日志"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "📄 删除完成后，查看日志文件："
echo ""
echo "ls -lt sync_delete_*.log | head -1"
echo ""
echo "cat sync_delete_20260202_203015.log"
echo ""
echo "日志内容示例："
cat << 'EOF'
同步删除日志
================================================================================
执行时间: 2026-02-02 20:30:15
源目录: /Users/xxx/wiznote_export/My Notes/读书笔记
目标目录: /Users/xxx/ObsidianVault
计划删除: 5 个文件
================================================================================

✅ 已删除: My Notes/读书笔记/启示录：如何打造用户喜爱的产品.md
   备份到: /Users/xxx/ObsidianVault/.sync_delete_trash/启示录：如何打造用户喜爱的产品.md_1
   源文件: My Notes/读书笔记/启示录：如何打造用户喜爱的产品.md

✅ 已删除: My Notes/读书笔记/从点子到产品：产品经理的价值观与方法论 读书笔记.md
   备份到: /Users/xxx/ObsidianVault/.sync_delete_trash/从点子到产品：产品经理的价值观与方法论 读书笔记.md_1
   源文件: My Notes/读书笔记/从点子到产品：产品经理的价值观与方法论 读书笔记.md

✅ 已删除: My Notes/读书笔记/金字塔原理.md
   备份到: /Users/xxx/ObsidianVault/.sync_delete_trash/金字塔原理.md_1
   源文件: My Notes/读书笔记/金字塔原理.md

✅ 已删除: My Notes/读书笔记/小狗钱钱.md
   备份到: /Users/xxx/ObsidianVault/.sync_delete_trash/小狗钱钱.md_1
   源文件: My Notes/读书笔记/小狗钱钱.md

✅ 已删除: My Notes/读书笔记/硅谷产品实战36讲——曲晓音.md
   备份到: /Users/xxx/ObsidianVault/.sync_delete_trash/硅谷产品实战36讲——曲晓音.md_1
   源文件: My Notes/读书笔记/硅谷产品实战36讲——曲晓音.md

================================================================================
删除完成: 成功 5 个，失败 0 个
================================================================================
EOF

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🔄 恢复误删的文件"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "如果误删，可以从备份目录恢复："
echo ""
echo "# 查看备份"
echo "ls ~/ObsidianVault/.sync_delete_trash/"
echo ""
echo "# 恢复文件"
echo "mv ~/ObsidianVault/.sync_delete_trash/启示录：如何打造用户喜爱的产品.md_1 \\"
echo "   ~/ObsidianVault/My\\ Notes/读书笔记/启示录：如何打造用户喜爱的产品.md"
echo ""

echo "╔══════════════════════════════════════════════════════════════╗"
echo "║  演示完成！                                                  ║"
echo "║                                                              ║"
echo "║  ✅ 工具特点：                                               ║"
echo "║     • 不会自动删除，必须明确使用 --confirm                 ║"
echo "║     • 显示完整删除清单和映射关系                            ║"
echo "║     • 需要手动输入 yes 确认                                  ║"
echo "║     • 所有删除操作都有备份                                  ║"
echo "║     • 生成详细日志，可追溯                                  ║"
echo "║                                                              ║"
echo "║  📖 详细文档：tools/同步删除工具使用说明.md                  ║"
echo "╚══════════════════════════════════════════════════════════════╝"
