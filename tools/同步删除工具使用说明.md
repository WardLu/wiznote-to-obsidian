# 同步删除工具使用说明

## 🎯 工具功能

安全地同步两个目录的删除操作，当你在源目录（如 `obsidian_export`）删除笔记后，自动在目标目录（Obsidian Vault）删除对应的笔记。

## ⚠️ 安全特性

1. **不会自动删除** - 必须明确使用 `--confirm` 参数
2. **完整报告** - 显示需要删除的文件、映射关系、统计信息
3. **人工确认** - 查看报告后需要手动输入 `yes` 确认
4. **备份机制** - 删除前先备份到 `.trash` 目录
5. **操作日志** - 生成详细的删除日志，可追溯

## 📝 使用流程

### 第一步：扫描差异（只查看，不删除）

```bash
cd tools

python3 sync_deletions.py \
  --source ~/wiznote_export/微博收藏 \
  --target ~/ObsidianVault/微博收藏 \
  --scan
```

**输出示例**：
```
🔍 扫描模式（只查看，不删除）

📊 统计信息
   源目录文件数: 50
   目标目录文件数: 100
   需要删除的文件: 50

⚠️  需要删除的文件清单
--------------------------------------------------------------------------------

1. 微博收藏/产品经理必读.md
   源文件: 微博收藏/产品经理必读.md
   映射关系: 微博收藏/产品经理必读.md → 微博收藏/产品经理必读.md
   相似度: 100.0%
   原因: 源文件已删除

2. 微博收藏/技术趋势分析.md
   源文件: 微博收藏/技术趋势分析.md
   映射关系: 微博收藏/技术趋势分析.md → 微博收藏/技术趋势分析.md
   相似度: 100.0%
   原因: 源文件已删除

...

⚠️  警告：以上文件将被删除！
```

### 第二步：查看删除清单

仔细检查输出，确认：
- ✅ 删除的文件是你想要的
- ✅ 映射关系正确
- ✅ 没有误删重要文件

### 第三步：确认删除

**⚠️ 重要：只有确认无误后，才执行此步骤！**

```bash
python3 sync_deletions.py \
  --source ~/wiznote_export/微博收藏 \
  --target ~/ObsidianVault/微博收藏 \
  --confirm
```

系统会要求你输入 `yes` 确认：

```
⚠️  确认删除操作
================================================================================
你已查看删除清单，确认要删除这些文件吗？(yes/no):
```

### 第四步：查看删除日志

删除完成后，查看日志文件：

```bash
cat sync_delete_20260202_202143.log
```

日志示例：
```
同步删除日志
================================================================================
执行时间: 2026-02-02 20:21:43
源目录: /Users/xxx/wiznote_export/微博收藏
目标目录: /Users/xxx/ObsidianVault/微博收藏
计划删除: 50 个文件
================================================================================

✅ 已删除: 微博收藏/产品经理必读.md
   备份到: /Users/xxx/ObsidianVault/.sync_delete_trash/产品经理必读.md_1
   源文件: 微博收藏/产品经理必读.md

✅ 已删除: 微博收藏/技术趋势分析.md
   备份到: /Users/xxx/ObsidianVault/.sync_delete_trash/技术趋势分析.md_1
   源文件: 微博收藏/技术趋势分析.md

...

删除完成: 成功 50 个，失败 0 个
```

## 🔄 恢复删除的文件

如果误删，可以从 `.trash` 目录恢复：

```bash
# 查看备份目录
ls ~/ObsidianVault/.sync_delete_trash/

# 恢复文件
mv ~/ObsidianVault/.sync_delete_trash/产品经理必读.md_1 \
   ~/ObsidianVault/微博收藏/产品经理必读.md
```

## 🎯 实际使用场景

### 场景 1：清理微博收藏笔记

```bash
# 1. 在 obsidian_export/微博收藏 中删除不需要的笔记
# 2. 扫描差异
python3 sync_deletions.py \
  --source ~/wiznote_export/微博收藏 \
  --target ~/ObsidianVault/微博收藏 \
  --scan

# 3. 查看报告，确认无误后执行删除
python3 sync_deletions.py \
  --source ~/wiznote_export/微博收藏 \
  --target ~/ObsidianVault/微博收藏 \
  --confirm
```

### 场景 2：批量清理多个目录

```bash
# 清理微博收藏
python3 sync_deletions.py \
  --source ~/wiznote_export/微博收藏 \
  --target ~/ObsidianVault/微博收藏 \
  --scan && \
python3 sync_deletions.py \
  --source ~/wiznote_export/微博收藏 \
  --target ~/ObsidianVault/微博收藏 \
  --confirm

# 清理技术笔记
python3 sync_deletions.py \
  --source ~/wiznote_export/技术笔记 \
  --target ~/ObsidianVault/02_Areas/Coding \
  --scan && \
python3 sync_deletions.py \
  --source ~/wiznote_export/技术笔记 \
  --target ~/ObsidianVault/02_Areas/Coding \
  --confirm
```

## ⚠️ 注意事项

1. **先扫描，后删除** - 永远先使用 `--scan` 查看报告
2. **确认映射关系** - 检查源文件和目标文件的对应关系是否正确
3. **备份重要数据** - 虽然工具有备份机制，但最好提前备份整个 Vault
4. **分批处理** - 建议分目录分批处理，而不是一次性处理整个 Vault
5. **检查日志** - 删除后务必查看日志，确认删除结果

## 🔧 工作原理

1. **扫描源目录** - 记录源目录中存在的所有文件
2. **扫描目标目录** - 记录目标目录中存在的所有文件
3. **找差异** - 目标目录有但源目录没有的文件 = 需要删除的文件
4. **智能匹配** - 使用文件名和路径相似度算法匹配对应关系
5. **安全删除** - 先备份到 `.trash`，再删除，生成日志

## 📊 报告文件

- `.sync_delete_scan_report.json` - 扫描报告（自动生成）
- `sync_delete_YYYYMMDD_HHMMSS.log` - 删除日志（执行删除时生成）

## 🚨 常见问题

### Q: 如何取消删除操作？
A: 在确认提示时输入 `no` 或直接按 Ctrl+C

### Q: 删除错了怎么办？
A: 从 `.sync_delete_trash` 目录恢复文件

### Q: 工具会不会误删文件？
A: 不会，因为：
1. 必须明确使用 `--confirm` 才会删除
2. 删除前会显示完整清单
3. 所有删除操作都有备份

### Q: 可以批量处理多个目录吗？
A: 可以，但建议分批处理，每次处理一个目录，仔细检查后再继续
